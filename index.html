<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rotina & Foco | Setup de Estudos</title>
    <style>
        :root {
            --primary: #4F46E5;
            --primary-hover: #4338CA;
            --bg: #F3F4F6;
            --surface: #FFFFFF;
            --text: #1F2937;
            --text-light: #6B7280;
            --border: #E5E7EB;
            --success: #10B981;
            --danger: #EF4444;
            --focus-bg: #E0E7FF;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', system-ui, sans-serif; }
        body { background-color: var(--bg); color: var(--text); padding-bottom: 80px; }

        /* HEADER & NAV */
        header { background: var(--primary); color: white; padding: 1rem; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .nav-tabs { display: flex; justify-content: space-around; background: var(--surface); padding: 0.5rem; border-bottom: 1px solid var(--border); overflow-x: auto;}
        .tab-btn { background: none; border: none; padding: 0.75rem 1rem; cursor: pointer; font-weight: 600; color: var(--text-light); border-bottom: 3px solid transparent; transition: 0.3s; white-space: nowrap; }
        .tab-btn.active { color: var(--primary); border-bottom-color: var(--primary); }

        /* CONTAINERS */
        .view-section { display: none; padding: 1rem; max-width: 1200px; margin: 0 auto; animation: fadeIn 0.3s ease; }
        .view-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* BOTOES E INPUTS */
        button.btn { background: var(--primary); color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-weight: 600; transition: 0.2s; }
        button.btn:hover { background: var(--primary-hover); }
        button.btn-danger { background: var(--danger); }
        button.btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text); }
        input, select, textarea { width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: 6px; margin-bottom: 1rem; }

        /* AGENDA */
        .agenda-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; flex-wrap: wrap; gap: 10px; }
        .table-container { overflow-x: auto; background: var(--surface); border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        table { width: 100%; border-collapse: collapse; min-width: 800px; }
        th, td { border: 1px solid var(--border); padding: 0.5rem; text-align: center; vertical-align: top; width: 12.5%; }
        th { background: var(--bg); font-weight: 600; position: sticky; top: 0; }
        .time-col { font-weight: bold; color: var(--text-light); background: var(--bg); width: 80px; }
        .agenda-cell { height: 80px; cursor: pointer; transition: 0.2s; position: relative; }
        .agenda-cell:hover { background: #f9fafb; }
        .block-item { background: var(--primary); color: white; padding: 0.5rem; border-radius: 4px; font-size: 0.85rem; margin-bottom: 4px; box-shadow: 0 1px 2px rgba(0,0,0,0.1); text-align: left; overflow: hidden; display: flex; flex-direction: column; gap: 2px; }
        .block-title { font-weight: bold; }
        .block-time { font-size: 0.75rem; opacity: 0.9; }

        /* TAREFAS */
        .task-input-group { display: flex; gap: 0.5rem; margin-bottom: 1rem; flex-wrap: wrap; }
        .task-input-group input[type="text"] { flex: 1; min-width: 200px; margin-bottom: 0; }
        .task-list { background: var(--surface); border-radius: 8px; padding: 1rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .task-item { display: flex; align-items: center; gap: 1rem; padding: 0.75rem 0; border-bottom: 1px solid var(--border); }
        .task-item.completed span { text-decoration: line-through; color: var(--text-light); }
        .task-item input[type="checkbox"] { width: 20px; height: 20px; cursor: pointer; margin-bottom: 0; }
        .task-item button { margin-left: auto; background: none; border: none; color: var(--danger); cursor: pointer; font-size: 1.2rem; }

        /* FOCO (POMODORO) */
        .focus-container { text-align: center; background: var(--surface); padding: 3rem 1rem; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .timer-circle { width: 250px; height: 250px; border-radius: 50%; background: conic-gradient(var(--primary) 100%, #eee 0); display: flex; justify-content: center; align-items: center; margin: 0 auto 2rem auto; position: relative; transition: background 1s linear; }
        .timer-inner { width: 230px; height: 230px; background: var(--surface); border-radius: 50%; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .time-display { font-size: 3.5rem; font-weight: bold; color: var(--text); }
        .focus-controls { display: flex; justify-content: center; gap: 1rem; margin-bottom: 2rem;}

        /* MODAIS */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 1000; padding: 1rem; }
        .modal-overlay.active { display: flex; }
        .modal-content { background: var(--surface); padding: 1.5rem; border-radius: 8px; width: 100%; max-width: 400px; max-height: 90vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; margin-bottom: 1rem; align-items: center; }
        .modal-header h3 { margin: 0; }
        .close-modal { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-light); }
        
        .flex-row { display: flex; gap: 1rem; }
        .flex-row > div { flex: 1; }
        label { display: block; font-size: 0.85rem; font-weight: 600; margin-bottom: 0.25rem; color: var(--text-light); }
        
        /* UTILIDADES */
        .hidden { display: none !important; }
        .notify-badge { background: var(--success); width: 10px; height: 10px; border-radius: 50%; display: inline-block; }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
</head>
<body>

    <header>
        <h1>üß† Setup de Estudos & Rotina</h1>
        <p id="notify-status" style="font-size: 0.8rem; margin-top: 5px; opacity: 0.8;">Verificando permiss√£o de notifica√ß√µes...</p>
    </header>

    <nav class="nav-tabs">
        <button class="tab-btn active" onclick="switchTab('agenda')">üìÖ Agenda Semanal</button>
        <button class="tab-btn" onclick="switchTab('tarefas')">‚úÖ Tarefas</button>
        <button class="tab-btn" onclick="switchTab('foco')">üå± Modo Foco</button>
        <button class="tab-btn" onclick="switchTab('config')">‚öôÔ∏è Configura√ß√µes</button>
    </nav>

    <main id="view-agenda" class="view-section active">
        <div class="agenda-header">
            <h2>Sua Semana</h2>
            <div>
                <button class="btn btn-outline" style="background: #10B981; color: white; border: none;" onclick="baixarPDF()">üì• Baixar PDF</button>
                <button class="btn btn-outline" onclick="openTimesModal()">‚è∞ Editar Hor√°rios Base</button>
                <button class="btn" onclick="openBlockModal()">‚ûï Novo Bloco</button>
            </div>
        </div>
        <div class="table-container">
            <table id="agenda-table">
                <thead>
                    <tr>
                        <th class="time-col">Hor√°rio</th>
                        <th>Segunda</th><th>Ter√ßa</th><th>Quarta</th><th>Quinta</th><th>Sexta</th><th>S√°bado</th><th>Domingo</th>
                    </tr>
                </thead>
                <tbody id="agenda-body">
                    </tbody>
            </table>
        </div>
        <p style="font-size: 0.8rem; color: var(--text-light); margin-top: 10px;">Dica: Clique em qualquer c√©lula vazia para adicionar uma atividade, ou clique em uma atividade para edit√°-la.</p>
    </main>

    <main id="view-tarefas" class="view-section">
        <h2>Controle de Tarefas</h2>
        <div class="task-input-group" style="margin-top: 1rem;">
            <input type="text" id="new-task-title" placeholder="O que precisa ser feito?">
            <input type="date" id="new-task-date">
            <select id="new-task-priority" style="width: auto; margin-bottom: 0;">
                <option value="Baixa">üü¢ Baixa</option>
                <option value="M√©dia">üü° M√©dia</option>
                <option value="Alta">üî¥ Alta</option>
            </select>
            <button class="btn" onclick="addTask()">Adicionar</button>
        </div>
        <div class="task-list" id="task-list-container">
            </div>
    </main>

    <main id="view-foco" class="view-section">
        <div class="focus-container">
            <h2>Modo Foco </h2>
            <p style="color: var(--text-light); margin-bottom: 2rem;" id="focus-msg">Mantenha o foco. Plante seu futuro!</p>
            
            <div class="timer-circle" id="timer-circle">
                <div class="timer-inner">
                    <div class="time-display" id="time-display">25:00</div>
                    <div id="timer-mode" style="color: var(--text-light); font-weight: 600;">Trabalho</div>
                </div>
            </div>

            <div class="focus-controls">
                <button class="btn" id="btn-start-focus" onclick="startFocus()">‚ñ∂Ô∏è Iniciar</button>
                <button class="btn btn-danger" id="btn-stop-focus" onclick="stopFocus()" style="display: none;">‚èπÔ∏è Parar</button>
                <button class="btn btn-outline" onclick="openFocusConfig()">‚öôÔ∏è Configurar</button>
            </div>
        </div>
    </main>

    <main id="view-config" class="view-section">
        <h2>Configura√ß√µes do Sistema</h2>
        <div style="background: var(--surface); padding: 1rem; border-radius: 8px; margin-top: 1rem;">
            <p>Seus dados s√£o salvos automaticamente no seu navegador (Offline).</p>
            <button class="btn btn-danger" style="margin-top: 1rem;" onclick="factoryReset()">‚ö†Ô∏è Apagar todos os dados</button>
            <button class="btn btn-outline" style="margin-top: 1rem;" onclick="requestNotificationPermission()">üîî For√ßar permiss√£o de Notifica√ß√£o</button>
        </div>
    </main>

    <div class="modal-overlay" id="modal-block">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-block-title">Adicionar Atividade</h3>
                <button class="close-modal" onclick="closeModal('modal-block')">√ó</button>
            </div>
            <input type="hidden" id="block-id">
            <label>T√≠tulo / Mat√©ria</label>
            <input type="text" id="block-text" placeholder="Ex: Matem√°tica, Treino...">
            
            <div class="flex-row">
                <div>
                    <label>Dia da Semana</label>
                    <select id="block-day">
                        <option value="1">Segunda</option>
                        <option value="2">Ter√ßa</option>
                        <option value="3">Quarta</option>
                        <option value="4">Quinta</option>
                        <option value="5">Sexta</option>
                        <option value="6">S√°bado</option>
                        <option value="7">Domingo</option>
                    </select>
                </div>
                <div>
                    <label>Tipo</label>
                    <select id="block-type">
                        <option value="estudo">üìö Estudo</option>
                        <option value="rotina">‚öôÔ∏è Rotina</option>
                        <option value="descanso">üõãÔ∏è Descanso</option>
                        <option value="livre">üåü Livre</option>
                    </select>
                </div>
            </div>

            <div class="flex-row">
                <div>
                    <label>In√≠cio (HH:MM)</label>
                    <input type="time" id="block-start">
                </div>
                <div>
                    <label>Fim (HH:MM)</label>
                    <input type="time" id="block-end">
                </div>
            </div>

            <div class="flex-row">
                <div>
                    <label>Cor de Fundo</label>
                    <input type="color" id="block-color" value="#4F46E5" style="height: 40px; padding: 2px;">
                </div>
                <div>
                    <label>Emoji</label>
                    <input type="text" id="block-emoji" placeholder="Ex: üìñ" maxlength="2">
                </div>
            </div>

            <div style="background: var(--bg); padding: 1rem; border-radius: 6px; margin-bottom: 1rem;">
                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                    <input type="checkbox" id="block-notify" style="width: auto; margin:0;"> 
                    <strong>Notificar sobre esta atividade</strong>
                </label>
                <div id="notify-opts" style="margin-top: 0.5rem; display: none;">
                    <label>Avisar quantos minutos antes?</label>
                    <input type="number" id="block-notify-min" value="10" min="0" max="60">
                </div>
            </div>

            <div style="display: flex; justify-content: space-between; gap: 10px;">
                <button class="btn" style="flex: 2;" onclick="saveBlock()">Salvar</button>
                <button class="btn btn-danger" style="flex: 1; display: none;" id="btn-delete-block" onclick="deleteBlock()">Excluir</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="modal-times">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Gerenciar Hor√°rios Base</h3>
                <button class="close-modal" onclick="closeModal('modal-times')">√ó</button>
            </div>
            <p style="font-size: 0.85rem; color: var(--text-light); margin-bottom: 1rem;">Adicione os hor√°rios que aparecer√£o na coluna lateral da sua agenda (Ex: 08:00).</p>
            <div id="times-list" style="max-height: 200px; overflow-y: auto; margin-bottom: 1rem;"></div>
            <div style="display: flex; gap: 10px;">
                <input type="time" id="new-time-input">
                <button class="btn" onclick="addBaseTime()">Adicionar</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="modal-foco-config">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Configurar Modo Foco</h3>
                <button class="close-modal" onclick="closeModal('modal-foco-config')">√ó</button>
            </div>
            <label>Tempo de Foco (Minutos)</label>
            <input type="number" id="cfg-focus-time" value="25">
            <label>Tempo de Pausa Curta (Minutos)</label>
            <input type="number" id="cfg-break-time" value="5">
            <button class="btn" style="width: 100%;" onclick="saveFocusConfig()">Salvar Configura√ß√µes</button>
        </div>
    </div>

    <script>
        /* ==========================================
           1. ESTADO GLOBAL E SALVAMENTO (LOCALSTORAGE)
           ========================================== */
        const DEFAULT_TIMES = ['07:00', '08:00', '09:00', '10:00', '11:00', '12:00', '14:00', '16:00', '18:00', '20:00'];
        
        let state = {
            times: JSON.parse(localStorage.getItem('userTimes')) || DEFAULT_TIMES,
            blocks: JSON.parse(localStorage.getItem('userBlocks')) || [],
            tasks: JSON.parse(localStorage.getItem('userTasks')) || [],
            foco: JSON.parse(localStorage.getItem('userFoco')) || { focus: 25, break: 5 },
            notifiedKeys: JSON.parse(localStorage.getItem('userNotifiedKeys')) || [] // Evitar spam de notifica√ß√£o
        };

        function saveData() {
            localStorage.setItem('userTimes', JSON.stringify(state.times));
            localStorage.setItem('userBlocks', JSON.stringify(state.blocks));
            localStorage.setItem('userTasks', JSON.stringify(state.tasks));
            localStorage.setItem('userFoco', JSON.stringify(state.foco));
            localStorage.setItem('userNotifiedKeys', JSON.stringify(state.notifiedKeys));
        }

        /* ==========================================
           2. NAVEGA√á√ÉO E UI GERAL
           ========================================== */
        function switchTab(tabId) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(`view-${tabId}`).classList.add('active');
            event.currentTarget.classList.add('active');
        }

        function openModal(id) { document.getElementById(id).classList.add('active'); }
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }

        /* ==========================================
           3. AGENDA E BLOCOS
           ========================================== */
        function renderAgenda() {
            const tbody = document.getElementById('agenda-body');
            tbody.innerHTML = '';
            
            // Ordenar hor√°rios
            state.times.sort();

            state.times.forEach(time => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td class="time-col">${time}</td>`;
                
                for (let day = 1; day <= 7; day++) {
                    const td = document.createElement('td');
                    td.className = 'agenda-cell';
                    td.onclick = (e) => {
                        if(e.target === td) openEmptyBlockModal(day, time);
                    };

                    // Buscar blocos para este dia que come√ßam neste hor√°rio (simplifica√ß√£o visual)
                    const dayBlocks = state.blocks.filter(b => b.day == day && b.start >= time && b.start < getNextTime(time));
                    
                    dayBlocks.forEach(b => {
                        const div = document.createElement('div');
                        div.className = 'block-item';
                        div.style.backgroundColor = b.color || 'var(--primary)';
                        div.innerHTML = `
                            <span class="block-title">${b.emoji || ''} ${b.title} ${b.notify ? 'üîî' : ''}</span>
                            <span class="block-time">${b.start} - ${b.end}</span>
                        `;
                        div.onclick = (e) => {
                            e.stopPropagation();
                            editBlock(b.id);
                        };
                        td.appendChild(div);
                    });

                    tr.appendChild(td);
                }
                tbody.appendChild(tr);
            });
        }

        function getNextTime(currentTime) {
            const idx = state.times.indexOf(currentTime);
            return (idx !== -1 && idx < state.times.length - 1) ? state.times[idx + 1] : '23:59';
        }

        // Evento de Checkbox Notifica√ß√£o no Modal
        document.getElementById('block-notify').addEventListener('change', function() {
            document.getElementById('notify-opts').style.display = this.checked ? 'block' : 'none';
        });

        function openEmptyBlockModal(day, time) {
            document.getElementById('block-id').value = '';
            document.getElementById('block-text').value = '';
            document.getElementById('block-day').value = day;
            document.getElementById('block-start').value = time;
            document.getElementById('block-end').value = getNextTime(time);
            document.getElementById('block-type').value = 'estudo';
            document.getElementById('block-color').value = '#4F46E5';
            document.getElementById('block-emoji').value = 'üìö';
            document.getElementById('block-notify').checked = true;
            document.getElementById('notify-opts').style.display = 'block';
            document.getElementById('block-notify-min').value = '10';
            
            document.getElementById('btn-delete-block').style.display = 'none';
            document.getElementById('modal-block-title').innerText = 'Nova Atividade';
            openModal('modal-block');
        }

        function editBlock(id) {
            const b = state.blocks.find(x => x.id == id);
            if(!b) return;
            
            document.getElementById('block-id').value = b.id;
            document.getElementById('block-text').value = b.title;
            document.getElementById('block-day').value = b.day;
            document.getElementById('block-start').value = b.start;
            document.getElementById('block-end').value = b.end;
            document.getElementById('block-type').value = b.type || 'estudo';
            document.getElementById('block-color').value = b.color || '#4F46E5';
            document.getElementById('block-emoji').value = b.emoji || '';
            document.getElementById('block-notify').checked = b.notify || false;
            document.getElementById('notify-opts').style.display = b.notify ? 'block' : 'none';
            document.getElementById('block-notify-min').value = b.notifyMin || '10';

            document.getElementById('btn-delete-block').style.display = 'block';
            document.getElementById('modal-block-title').innerText = 'Editar Atividade';
            openModal('modal-block');
        }

        function saveBlock() {
            const id = document.getElementById('block-id').value;
            const newBlock = {
                id: id ? id : Date.now().toString(),
                title: document.getElementById('block-text').value || 'Sem t√≠tulo',
                day: parseInt(document.getElementById('block-day').value),
                start: document.getElementById('block-start').value,
                end: document.getElementById('block-end').value,
                type: document.getElementById('block-type').value,
                color: document.getElementById('block-color').value,
                emoji: document.getElementById('block-emoji').value,
                notify: document.getElementById('block-notify').checked,
                notifyMin: parseInt(document.getElementById('block-notify-min').value) || 0
            };

            if(id) {
                const idx = state.blocks.findIndex(x => x.id == id);
                state.blocks[idx] = newBlock;
            } else {
                state.blocks.push(newBlock);
            }

            saveData();
            renderAgenda();
            closeModal('modal-block');
        }

        function deleteBlock() {
            const id = document.getElementById('block-id').value;
            state.blocks = state.blocks.filter(x => x.id != id);
            saveData();
            renderAgenda();
            closeModal('modal-block');
        }

        /* GERENCIAR HOR√ÅRIOS BASE */
        function openTimesModal() {
            renderTimesList();
            openModal('modal-times');
        }

        function renderTimesList() {
            const container = document.getElementById('times-list');
            container.innerHTML = '';
            state.times.sort().forEach(t => {
                const div = document.createElement('div');
                div.style.display = 'flex'; div.style.justifyContent = 'space-between'; div.style.padding = '5px 0'; div.style.borderBottom = '1px solid #eee';
                div.innerHTML = `<span>${t}</span> <button style="color:red; background:none; border:none; cursor:pointer;" onclick="removeBaseTime('${t}')">Remover</button>`;
                container.appendChild(div);
            });
        }

        function addBaseTime() {
            const val = document.getElementById('new-time-input').value;
            if(val && !state.times.includes(val)) {
                state.times.push(val);
                saveData();
                renderTimesList();
                renderAgenda();
            }
        }

        function removeBaseTime(timeStr) {
            state.times = state.times.filter(t => t !== timeStr);
            saveData();
            renderTimesList();
            renderAgenda();
        }

        /* ==========================================
           4. TAREFAS (TODOIST STYLE)
           ========================================== */
        function renderTasks() {
            const container = document.getElementById('task-list-container');
            container.innerHTML = '';
            
            if(state.tasks.length === 0) {
                container.innerHTML = '<p style="color:var(--text-light); text-align:center;">Nenhuma tarefa pendente. Voc√™ est√° em dia! üéâ</p>';
                return;
            }

            // Ordenar: n√£o conclu√≠das primeiro, depois por data
            state.tasks.sort((a,b) => a.completed - b.completed).forEach(t => {
                const div = document.createElement('div');
                div.className = `task-item ${t.completed ? 'completed' : ''}`;
                
                let priorityIcon = t.priority === 'Alta' ? 'üî¥' : (t.priority === 'M√©dia' ? 'üü°' : 'üü¢');

                div.innerHTML = `
                    <input type="checkbox" ${t.completed ? 'checked' : ''} onchange="toggleTask('${t.id}')">
                    <span style="flex:1;">
                        <strong>${t.title}</strong> 
                        <br><small style="color:var(--text-light)">${priorityIcon} Prioridade ${t.priority} ${t.date ? '| üìÖ ' + formatDataBr(t.date) : ''}</small>
                    </span>
                    <button onclick="deleteTask('${t.id}')">üóëÔ∏è</button>
                `;
                container.appendChild(div);
            });
        }

        function addTask() {
            const title = document.getElementById('new-task-title').value;
            if(!title) return alert('Digite um t√≠tulo para a tarefa.');
            
            const newTask = {
                id: Date.now().toString(),
                title: title,
                date: document.getElementById('new-task-date').value,
                priority: document.getElementById('new-task-priority').value,
                completed: false
            };
            
            state.tasks.push(newTask);
            saveData();
            document.getElementById('new-task-title').value = '';
            renderTasks();
        }

        function toggleTask(id) {
            const t = state.tasks.find(x => x.id === id);
            if(t) t.completed = !t.completed;
            saveData();
            renderTasks();
        }

        function deleteTask(id) {
            state.tasks = state.tasks.filter(x => x.id !== id);
            saveData();
            renderTasks();
        }

        function formatDataBr(dateStr) {
            if(!dateStr) return '';
            const [y, m, d] = dateStr.split('-');
            return `${d}/${m}/${y}`;
        }

        /* ==========================================
           5. MODO FOCO (POMODORO)
           ========================================== */
        let focusInterval;
        let focusTimeLeft = state.foco.focus * 60;
        let isFocusing = false;
        let totalTime = state.foco.focus * 60;

        function updateFocusDisplay() {
            const m = Math.floor(focusTimeLeft / 60).toString().padStart(2, '0');
            const s = (focusTimeLeft % 60).toString().padStart(2, '0');
            document.getElementById('time-display').innerText = `${m}:${s}`;
            
            // Atualizar c√≠rculo (Conic Gradient)
            const progress = ((totalTime - focusTimeLeft) / totalTime) * 100;
            document.getElementById('timer-circle').style.background = `conic-gradient(#eee ${progress}%, var(--primary) ${progress}%)`;
        }

        function startFocus() {
            if(isFocusing) return;
            isFocusing = true;
            document.getElementById('btn-start-focus').style.display = 'none';
            document.getElementById('btn-stop-focus').style.display = 'inline-block';
            document.getElementById('focus-msg').innerText = "Foco total! N√£o se distraia agora.";

            focusInterval = setInterval(() => {
                focusTimeLeft--;
                updateFocusDisplay();
                
                if(focusTimeLeft <= 0) {
                    clearInterval(focusInterval);
                    sendNotification("Sess√£o Conclu√≠da! üéâ", "Excelente trabalho. Hora de uma pausa.");
                    stopFocus();
                    // Preparar pausa
                    focusTimeLeft = state.foco.break * 60;
                    totalTime = state.foco.break * 60;
                    document.getElementById('timer-mode').innerText = "Pausa";
                    updateFocusDisplay();
                }
            }, 1000);
        }

        function stopFocus() {
            clearInterval(focusInterval);
            isFocusing = false;
            document.getElementById('btn-start-focus').style.display = 'inline-block';
            document.getElementById('btn-stop-focus').style.display = 'none';
            document.getElementById('focus-msg').innerText = "Mantenha o foco. Plante seu futuro!";
            document.getElementById('timer-mode').innerText = "Trabalho";
            focusTimeLeft = state.foco.focus * 60;
            totalTime = focusTimeLeft;
            updateFocusDisplay();
        }

        function openFocusConfig() {
            document.getElementById('cfg-focus-time').value = state.foco.focus;
            document.getElementById('cfg-break-time').value = state.foco.break;
            openModal('modal-foco-config');
        }

        function saveFocusConfig() {
            state.foco.focus = parseInt(document.getElementById('cfg-focus-time').value) || 25;
            state.foco.break = parseInt(document.getElementById('cfg-break-time').value) || 5;
            saveData();
            stopFocus(); // Reseta timer com novo valor
            closeModal('modal-foco-config');
        }


        /* ==========================================
           6. SISTEMA DE NOTIFICA√á√ïES (CRONJOB NAVEGADOR)
           ========================================== */
        function requestNotificationPermission() {
            if (!("Notification" in window)) {
                alert("Este navegador n√£o suporta notifica√ß√µes de sistema.");
            } else if (Notification.permission === "granted") {
                document.getElementById('notify-status').innerText = "üîî Notifica√ß√µes Ativas";
                document.getElementById('notify-status').style.color = "var(--success)";
            } else if (Notification.permission !== "denied") {
                Notification.requestPermission().then(permission => {
                    if (permission === "granted") {
                        document.getElementById('notify-status').innerText = "üîî Notifica√ß√µes Ativas";
                        document.getElementById('notify-status').style.color = "var(--success)";
                    }
                });
            }
        }

        function sendNotification(title, body) {
            if (Notification.permission === "granted") {
                new Notification(title, { body: body, icon: "https://cdn-icons-png.flaticon.com/512/3208/3208726.png" });
            }
        }

        function checkRoutineNotifications() {
            const now = new Date();
            const currentDayStr = now.toISOString().split('T')[0]; // YYYY-MM-DD
            // getDay() no JS: 0=Domingo, 1=Segunda ... 6=S√°bado. 
            // Nossa l√≥gica: 1=Segunda, 7=Domingo
            let dayOfWeek = now.getDay(); 
            dayOfWeek = dayOfWeek === 0 ? 7 : dayOfWeek; 

            const currentHour = now.getHours();
            const currentMin = now.getMinutes();
            const currentTimeInMins = currentHour * 60 + currentMin;

            state.blocks.forEach(block => {
                if(!block.notify || block.day != dayOfWeek) return;

                const [bHour, bMin] = block.start.split(':').map(Number);
                const blockTimeInMins = bHour * 60 + bMin;
                const targetNotifyTimeInMins = blockTimeInMins - block.notifyMin;

                // Checa se √© exatamente a hora de notificar (com uma pequena margem de 1 minuto)
                if(currentTimeInMins === targetNotifyTimeInMins) {
                    const notifyKey = `${currentDayStr}-${block.id}`;
                    if(!state.notifiedKeys.includes(notifyKey)) {
                        
                        let msg = `Sua atividade come√ßa √†s ${block.start}.`;
                        if(block.type === 'estudo') msg = `Seu futuro agradece. Come√ßa √†s ${block.start}.`;

                        sendNotification(`‚è∞ Hora de: ${block.emoji || ''} ${block.title}`, msg);
                        
                        // Marca como notificado hoje
                        state.notifiedKeys.push(notifyKey);
                        // Limpa chaves antigas para n√£o lotar localStorage (mant√©m apenas as √∫ltimas 50)
                        if(state.notifiedKeys.length > 50) state.notifiedKeys.shift();
                        saveData();
                    }
                }
            });
        }

        // Loop de checagem a cada 60 segundos
        setInterval(checkRoutineNotifications, 60000);

        function factoryReset() {
            if(confirm("TEM CERTEZA? Isso apagar√° todos os seus blocos, tarefas e hor√°rios.")) {
                localStorage.clear();
                location.reload();
            }
        }

        /* ==========================================
           7. INICIALIZA√á√ÉO
           ========================================== */
        window.onload = () => {
            requestNotificationPermission();
            renderAgenda();
            renderTasks();
            updateFocusDisplay();
            // Inicia o checador de notifica√ß√£o imediatamente para pegar o minuto atual
            checkRoutineNotifications();
        };
/* ==========================================
           8. EXPORTAR PARA PDF
           ========================================== */
        function baixarPDF() {
            const elemento = document.getElementById('agenda-table');
            
            const opcoes = {
                margin:       0.3,
                filename:     'minha-rotina-de-estudos.pdf',
                image:        { type: 'jpeg', quality: 0.98 },
                html2canvas:  { scale: 2, useCORS: true },
                jsPDF:        { unit: 'in', format: 'a4', orientation: 'landscape' }
            };

            // Muda o texto do bot√£o temporariamente para mostrar que est√° carregando
            const btn = event.currentTarget;
            const textoOriginal = btn.innerText;
            btn.innerText = "‚è≥ Gerando PDF...";

            html2pdf().set(opcoes).from(elemento).save().then(() => {
                btn.innerText = textoOriginal;
            });
        }
    </script>
</body>
</html>